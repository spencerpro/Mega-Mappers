<!DOCTYPE html>
<html>
<head>
    <title>Codex DM Screen</title>
    <link rel="icon" href="/favicon.ico">
    <style>
        body { display: flex; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; height: 100vh; margin: 0; background: #1e1e1e; color: #e0e0e0; }
        #sidebar { width: 320px; background: #252526; display: flex; flex-direction: column; border-right: 1px solid #333; flex-shrink: 0; }
        #nav-header { padding: 15px; background: #2d2d2d; border-bottom: 1px solid #3e3e3e; font-weight: 600; color: #fff; user-select: none;}
        #nav-list { flex: 1; overflow-y: auto; padding: 8px; }
        .node-item { padding: 8px 12px; margin-bottom: 2px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; color: #ccc; user-select: none; }
        .node-item:hover { background: #2a2d2e; color: #fff; }
        .node-item.active { background: #007acc; color: #fff; }
        .node-item .icon { margin-right: 10px; width: 20px; text-align: center; }
        .nav-up { background: #3a3a40; margin-bottom: 10px; border: 1px solid #4a4a50; color: #aaddff; font-weight: bold;}
        .nav-up:hover { background: #4a4a50; }
        #editor-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #editor-header { padding: 20px 40px; border-bottom: 1px solid #333; }
        #editor-header h1 { margin: 0; font-size: 1.8em; font-weight: 300; }
        #editor-content { flex: 1; overflow-y: auto; padding: 40px; max-width: 900px; }
        .form-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; color: #858585; font-size: 0.85em; font-weight: 600; text-transform: uppercase; }
        input, textarea, select { width: 100%; padding: 10px; background: #3c3c3c; border: 1px solid #3c3c3c; color: #f0f0f0; border-radius: 2px; font-family: inherit; font-size: 1em; box-sizing: border-box; }
        .btn { padding: 10px 24px; border: none; border-radius: 2px; cursor: pointer; font-size: 0.9em; font-weight: 600; background: #0e639c; color: white; }
    </style>
</head>
<body>
<div id="sidebar"><div id="nav-header">Campaigns</div><div id="nav-list"></div></div>
<div id="editor-container">
    <div id="editor-header"><h1>Codex Engine</h1></div>
    <div id="editor-content"></div>
    <div style="padding: 20px 40px; border-top: 1px solid #333; text-align: right;"><button class="btn" id="save-btn" style="display:none">Save Changes</button></div>
</div>
<script>
    const API_URL = "/api";
    let navStack = [];
    let currentContainerUid = null;

    async function init() {
        // Start at the root level (campaign list)
        navigateTo(null, "Campaigns");
    }

    // The single function to handle all navigation
    async function navigateTo(uid, title) {
        // Push the CURRENT state to history before navigating to the NEW one
        // BUT: Don't push if current is a tactical map (dungeon_level, building_interior)
        // This keeps Back pointed at the marker/list level
        const currentIsTactical = currentContainerUid && 
            (currentContainerUid.startsWith('dungeon_level:') || 
             currentContainerUid.startsWith('building_interior:'));
        
        if (uid !== null && !currentIsTactical) {
            navStack.push({ uid: currentContainerUid, title: document.getElementById('nav-header').innerText });
        }

        currentContainerUid = uid;
        document.getElementById('nav-header').innerText = title;
        const list = document.getElementById('nav-list');
        list.innerHTML = '<div>Loading...</div>';

        // Fetch data for the place we are navigating TO
        const url = uid ? `${API_URL}/tree/${uid}` : `${API_URL}/tree`;
        const res = await fetch(url);
        const data = await res.json();
        
        // The server response tells us what the children are
        const children = uid ? data.children : data;
        renderSidebar(children);
        
        // Auto-select and load the editor for the container's own details
        if (uid && children.length > 0) {
            loadEditor(children[0].uid);
            setActiveItem(children[0].uid);
        } else {
            // Clear editor if at root
            document.getElementById('editor-content').innerHTML = '';
            document.getElementById('editor-header').innerHTML = '<h1>Select a Campaign</h1>';
            document.getElementById('save-btn').style.display = 'none';
        }
    }

    function renderSidebar(children) {
        const list = document.getElementById('nav-list');
        list.innerHTML = '';

        // Back button logic based on the history stack
        if (navStack.length > 0) {
            const prev = navStack[navStack.length - 1];
            const backBtn = document.createElement('div');
            backBtn.className = 'node-item nav-up';
            backBtn.innerHTML = `<span class="icon">⬅️</span> Back to ${prev.title}`;
            backBtn.onclick = () => { 
                const lastState = navStack.pop();
                navigateTo(lastState.uid, lastState.title); 
            };
            list.appendChild(backBtn);
        }

        children.forEach(c => {
            const div = document.createElement('div');
            div.className = 'node-item';
            div.id = `node-${c.uid}`;
            div.innerHTML = `<span class="icon">${c.icon}</span> ${c.name}`;
            
            // Check if we're currently viewing a tactical map
            const inTacticalMap = currentContainerUid && 
                (currentContainerUid.startsWith('dungeon_level:') || 
                 currentContainerUid.startsWith('building_interior:'));
            
            // Info nodes always just load the editor
            const isInfoNode = c.type.endsWith("-info");
            // Markers and NPCs when inside tactical maps should just load editor
            const isMarkerOrNpc = c.type === 'marker' || c.type === 'npc';
            
            if (isInfoNode || (inTacticalMap && isMarkerOrNpc)) {
                // Just load editor, don't navigate
                div.onclick = () => {
                    loadEditor(c.uid);
                    setActiveItem(c.uid);
                };
            } else {
                // Everything else navigates
                div.onclick = () => navigateTo(c.uid, c.name);
            }
            list.appendChild(div);
        });
    }

    async function loadEditor(uid) {
        const res = await fetch(`${API_URL}/tree/${uid}`);
        if(!res.ok) return;
        const data = await res.json();

        document.getElementById('editor-header').innerHTML = `<h1>${data.icon || ''} ${data.name}</h1>`;
        const container = document.getElementById('editor-content');
        container.innerHTML = '';
        const form = document.createElement('div');

        data.ui_schema.forEach(field => {
            const group = document.createElement('div'); group.className = 'form-group';
            const lbl = document.createElement('label'); lbl.innerText = field.label; group.appendChild(lbl);
            
            let input;
            const val = (data.data && data.data[field.key]) ? data.data[field.key] : "";
            
            if (field.type === 'textarea' || field.type === 'list') {
                input = document.createElement('textarea');
                input.value = (field.type === 'list' && Array.isArray(val)) ? val.join('\n') : val;
            } else {
                input = document.createElement('input');
                input.type = 'text'; input.value = val;
            }
            if(field.readonly) input.disabled = true;
            input.id = `field_${field.key}`; input.dataset.fieldType = field.type;
            group.appendChild(input);
            form.appendChild(group);
        });
        container.appendChild(form);

        const btn = document.getElementById('save-btn');
        btn.style.display = 'inline-block';
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        newBtn.onclick = () => saveData(uid, data.ui_schema, newBtn);
    }

    async function saveData(uid, schema, btn) {
        const payload = {};
        schema.forEach(field => {
            if(field.readonly) return;
            const el = document.getElementById(`field_${field.key}`);
            if(!el) return;
            payload[field.key] = (el.dataset.fieldType === 'list') ? el.value.split('\n').filter(s => s.trim() !== "") : el.value;
        });

        btn.innerText = "Saving..."; btn.disabled = true;
        await fetch(`${API_URL}/tree/${uid}`, { method: 'PATCH', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ data: payload }) });
        btn.innerText = "Saved!";
        setTimeout(() => { btn.innerText = "Save Changes"; btn.disabled = false; }, 1000);
    }
    
    function setActiveItem(uid) {
        document.querySelectorAll('.node-item').forEach(el => el.classList.remove('active'));
        if (uid) {
            const el = document.getElementById(`node-${uid}`);
            if(el) el.classList.add('active');
        }
    }

    init();
</script>
</body>
</html>
